
#user  nobody;
#worker_processes  1;

#error_log  /tmp/error.log   debug_core;
#error_log  /tmp/error.log  notice;
#error_log  /tmp/error.log  info;

#pid        logs/nginx.pid;
error_log /tmp/error.log info;  
events {
    worker_connections  1024;
}


http {
    log_format apidebug '$remote_addr "$request" s=$status us=$upstream_status '
        'uri="$uri" ru="$request_uri" auth="$http_authorization" '
        'cl=$content_length ct="$content_type"';
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /tmp/access.log  main;
#   access_log off;

#    error_log   /tmp/error.log debug;
#    error_log   /tmp/error.log info;
#    error_log   /tmp/error.log alert;

    add_header Access-Control-Allow-Origin 'http://localhost:5173';
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
    add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Range,Content-Type,Authorization';
    add_header Access-Control-Expose-Headers 'X-Location';
    add_header Access-Control-Allow-Credentials 'true';

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    gzip  on;
    gzip_min_length 20;
    gzip_comp_level 5;
    gzip_vary on;
    gzip_types  application/javascript application/x-javascript text/javascript image/png image/x-icon;
    gzip_static on;
    gzip_buffers 2 4k;
    gzip_http_version 1.1;

    server {
        listen       80;
        server_name  localhost;
        client_header_buffer_size 512k;
        large_client_header_buffers 7 512k;
 
    location ^~ /hls/keys/ {
    default_type application/octet-stream;
    alias /mnt/img/hlskeys/; 
    add_header Cache-Control "no-store" always;

    auth_basic "HLS";                         
    auth_basic_user_file /mnt/img/hls.htpasswd;
}

location ^~ /mnt/img/hlskeys/ { deny all; }

	location /live {
return 403;
	}

        # rtmp stat
#        location /stat {
#            rtmp_stat all;
#            rtmp_stat_stylesheet stat.xsl;
#        }

#        location /stat.xsl {
#            # you can move stat.xsl to a different location
#            root /oem/www;
#        }

        # rtmp control
        location /control {
            rtmp_control all;
        }

        location / {                                                                                                                                                           
            root    /app/www; 
            #root    /userdata/oem/www;			
            index  index.html index.htm;                                                                                                                                       
        }  

        location /mnt {
           alias /mnt;
#           autoindex on;
#           autoindex_exact_size on;
#           autoindex_localtime on;
           sendfile on;
           set $viewflag 0;
           if ($request_filename ~* .(txt|bmp|log|ini)$) {
             set $viewflag 1;
           }
           
            if ($request_uri ~* view$) {
              set $viewflag 2;
            }
            
             if ($viewflag = 1) {
               add_header Content-Disposition attachment;
             }
        }



        #error_page  404       /404.html;
        error_page  404         /;

        # redirect server error pages to the static page /50x.html
        #
        # error_page   500 502 503 504  /50x.html;
        # location = /50x.html {
        #     root   html;
        # }

        location /cgi-bin/ {
            gzip           off;
            root            /app/www;
			#root            /userdata/oem/www;
            fastcgi_pass   unix:/run/fcgiwrap.sock;
            fastcgi_index  entry.cgi;
            fastcgi_param  DOCUMENT_ROOT      /app/www/cgi-bin;
			#fastcgi_param  DOCUMENT_ROOT      /userdata/oem/www/cgi-bin;
            fastcgi_param  SCRIPT_NAME       /entry.cgi; 
            include        fastcgi_params;
            fastcgi_param  CONTENT_TYPE      $content_type;
            fastcgi_param  CONTENT_LENGTH    $content_length;
            set $path_info "";
            set $real_script_name $fastcgi_script_name;
            if ($fastcgi_script_name ~ "^(.+?\.cgi)(/.+)$") {
                set $real_script_name $1;
                set $path_info $2;
            }
            fastcgi_param SCRIPT_FILENAME /app/www$real_script_name;   # /oem/usr/www/cgi-bin/entry.cgi
            fastcgi_param SCRIPT_NAME     $real_script_name;                 # /cgi-bin/entry.cgi
            fastcgi_param PATH_INFO       $path_info;
            auth_basic off;
            fastcgi_param SCRIPT_FILENAME $document_root$real_script_name;
            fastcgi_param SCRIPT_NAME     $real_script_name;
            add_header Access-Control-Allow-Origin 'http://localhost:5173';
            add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Range,Content-Type,Authorization';
            add_header Access-Control-Expose-Headers 'X-Location';
            add_header Access-Control-Allow-Credentials 'true';
            fastcgi_param HTTP_AUTHORIZATION "";
            fastcgi_param REMOTE_USER "";
         }

        location /hls {   
             error_log /tmp/hls_error.log info;                                                                                                                                           
          types {                                                   
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
#           video/mp2t ts;                                                                
          }
#         alias /tmp/hls;                                                                                                      
          root /tmp;                                                                                             
          add_header Cache-Control no-cache;                                         
           auth_basic "HLS";  
           auth_basic_user_file /mnt/img/hls.htpasswd;   
           error_page 401 =403 /__deny_basic;                                              
           #To avoid issues with cross-domain HTTP requests (e.g. during development)                            
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Origin "http://localhost:5173" always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers "Authorization,Range,Origin,Accept" always;
    add_header Access-Control-Expose-Headers "Content-Length,Accept-Ranges,Content-Range" always;

    if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Methods "GET,OPTIONS" always;
        return 204;
    }
                 
        }   

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
        location = /__deny_basic { return 403; }
    }
    # HTTPS server
    
#    server {
#        listen       443 ssl;
#        server_name  localhost;
#
 #       ssl_certificate     /etc/ia.crt;
 #       ssl_certificate_key  /etc/ia.key;
#
#        ssl_session_cache    shared:SSL:1m;
 #       ssl_session_timeout  5m;
#
#        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
#       ssl_ciphers  HIGH:!aNULL:!MD5;
 #       ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
#        ssl_prefer_server_ciphers  on;
#
#        location /live {                                                                                        
#            flv_live on;                                                                                                                                          
#            chunked_transfer_encoding on;
#            add_header 'Access-Control-Allow-Origin' '*';
 #           add_header 'Access-Control-Allow-Credentials' 'true';                    
#        }
#
#
 #       location / {
 #           root   /oem/www;
 #           index  index.html index.htm;
#        }
#
#        location @router{
#            rewrite ^.*$ /index.html last;
#        }

#
 #      location /cgi-bin/ {                                                                                    
 #           gzip           off;                                                       
#            root           /userdata/oem/www;                                                                                                                          
#            fastcgi_pass   unix:/run/fcgiwrap.sock;                                   
#            fastcgi_index  entry.cgi;                                     
#            fastcgi_param  DOCUMENT_ROOT      /userdata/oem/www/cgi-bin;        
#            fastcgi_param  SCRIPT_NAME       /entry.cgi;                      
#            include        fastcgi_params;                                                                                                                        
#            set $path_info "";                                                                                                                                    
#            set $real_script_name $fastcgi_script_name;                                                                                                           
 #           if ($fastcgi_script_name ~ "^(.+?\.cgi)(/.+)$") {                                                                                                     
 #               set $real_script_name $1;                                             
#                set $path_info $2;                                        
 #           }                                                      
#            fastcgi_param PATH_INFO       $path_info;        
 #           fastcgi_param SCRIPT_FILENAME $document_root$real_script_name;                                      
 #           fastcgi_param SCRIPT_NAME     $real_script_name;
 #       }

#
#
#       location /hls {
 #           types {                                                   
#              application/vnd.apple.mpegurl m3u8;
 #             video/mp2t ts;                                                                
 #           }                                                                                                   
 #           root /tmp;                                                                                             
 #           add_header Cache-Control no-cache; 
#	    add_header 'Access-Control-Allow-Origin' '*' always;
#            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
#                
 #      }
#
#    }

}

rtmp {

    server {
        listen 1935;
        chunk_size 4096;
        #allow publish 127.0.0.1;
        #deny publish all;

        application live{
            live on;
            hls on;
            hls_path /tmp/hls;
            hls_nested off;
            hls_fragment 2s;
            hls_playlist_length 10s;
            hls_keys on;                      
            hls_key_path /mnt/img/hlskeys; 
            hls_key_url /hls/keys/;
            hls_fragments_per_key 10;  
            gop_cache on;             
            deny play all;
			#on_play  http://localhost:80/cgi-bin/entry.cgi/system/on_play;
			#on_done  http://localhost:80/cgi-bin/entry.cgi/system/on_done;
        }
    }
}


